name: Run Bot 24/7

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/deploy.yml'
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 525600  # 1 year (maximum allowed)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      
    - name: Verify secrets
      run: |
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          echo "Error: TELEGRAM_BOT_TOKEN secret not set"
          exit 1
        fi
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "Warning: TELEGRAM_CHANNEL secret not set"
        fi
        if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
          echo "Warning: CLOUDFLARE_TOKEN not set - traffic charts will not be available"
        fi
        echo "âœ“ Secrets verified"
      
    - name: Build bot
      run: |
        go build -o netblocks-telegram-bot ./cmd/telegram-bot
        chmod +x netblocks-telegram-bot
        echo "âœ“ Bot built successfully"
      
    - name: Start bot in background
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        nohup ./netblocks-telegram-bot > bot.log 2>&1 &
        BOT_PID=$!
        echo $BOT_PID > bot.pid
        echo "âœ“ Bot started with PID: $BOT_PID"
        echo "âœ“ Environment variables set"
        
    - name: Wait for initialization
      run: sleep 10
      
    - name: Verify bot is running
      run: |
        if [ -f bot.pid ]; then
          BOT_PID=$(cat bot.pid)
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "âœ“ Bot is running with PID: $BOT_PID"
            echo ""
            echo "============================================"
            echo "Full startup logs (showing Cloudflare auth):"
            echo "============================================"
            cat bot.log
            echo ""
            echo "============================================"
            echo "Bot started successfully!"
            echo "Channel: ${{ secrets.TELEGRAM_CHANNEL }}"
            echo "Entering monitoring mode..."
            echo "This workflow will run forever (never complete)"
            echo "============================================"
          else
            echo "âœ— Bot process not found"
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
        else
          echo "âœ— bot.pid file not found"
          exit 1
        fi
    
    - name: Monitor bot forever
      run: |
        BOT_PID=$(cat bot.pid)
        COUNTER=1
        
        echo ""
        echo "ðŸ¤– NetBlocks Bot is now running 24/7"
        echo "ðŸ“Š Monitoring Iranian ASNs and DNS servers"
        echo "ðŸ“¢ Sending updates to Telegram channel every 10 minutes"
        echo ""
        
        # Print Cloudflare authentication status from bot logs
        echo "=========================================="
        echo "ðŸ”‘ Cloudflare Authentication Status:"
        echo "=========================================="
        
        # Check if token was passed to bot (from bot logs)
        if [ -f bot.log ]; then
          if grep -q "NewTrafficMonitor: token set=true" bot.log 2>/dev/null; then
            TOKEN_LINE=$(grep "NewTrafficMonitor: token set=true" bot.log | tail -1)
            echo "âœ… Bot process received Cloudflare token"
            echo "   $TOKEN_LINE"
            
            # Extract token length if available
            if echo "$TOKEN_LINE" | grep -q "len="; then
              TOKEN_LEN=$(echo "$TOKEN_LINE" | sed -n 's/.*len=\([0-9]*\).*/\1/p')
              echo "   Token length: $TOKEN_LEN characters"
            fi
          elif grep -q "NewTrafficMonitor: token set=false" bot.log 2>/dev/null; then
            echo "âŒ Bot process did NOT receive Cloudflare token"
            echo "   Check if CLOUDFLARE_TOKEN secret is set in repository settings"
          else
            echo "â³ Waiting for bot to initialize and check token..."
            echo "   Will check again on next iteration"
          fi
          
          # Check authentication method used
          if grep -q "Using Cloudflare Bearer Token authentication" bot.log 2>/dev/null; then
            AUTH_LINE=$(grep "Using Cloudflare Bearer Token authentication" bot.log | tail -1)
            echo "âœ… Authentication method: Bearer Token"
            if echo "$AUTH_LINE" | grep -q "token length:"; then
              echo "   $AUTH_LINE"
            fi
          elif grep -q "Using Cloudflare API Key authentication" bot.log 2>/dev/null; then
            AUTH_LINE=$(grep "Using Cloudflare API Key authentication" bot.log | tail -1)
            echo "âš ï¸  Authentication method: API Key (legacy)"
            echo "   $AUTH_LINE"
          elif grep -q "WARNING: No Cloudflare credentials available" bot.log 2>/dev/null; then
            echo "âŒ No Cloudflare credentials available"
            echo "   Set CLOUDFLARE_TOKEN secret in repository settings"
          fi
          
          # Check for Cloudflare API responses
          if grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
            echo ""
            echo "ðŸ“¡ Recent Cloudflare API responses:"
            grep "Cloudflare API response: Status" bot.log | tail -3 | while read line; do
              echo "   $line"
            done
            
            # Check for successful responses
            if grep -q "Cloudflare API response: Status 200" bot.log 2>/dev/null; then
              echo "   âœ… API calls are succeeding (Status 200)"
            fi
            
            # Check for authentication errors
            if grep -q "Cloudflare API response: Status 401" bot.log 2>/dev/null; then
              echo "   âŒ Authentication failed (Status 401) - Token may be invalid"
              ERROR_MSG=$(grep -A 2 "Cloudflare API response: Status 401" bot.log | grep "Cloudflare API error" | tail -1)
              if [ -n "$ERROR_MSG" ]; then
                echo "   $ERROR_MSG"
              fi
            fi
            
            if grep -q "Cloudflare API response: Status 403" bot.log 2>/dev/null; then
              echo "   âŒ Permission denied (Status 403) - Token lacks Radar permission"
              ERROR_MSG=$(grep -A 2 "Cloudflare API response: Status 403" bot.log | grep "Cloudflare API error" | tail -1)
              if [ -n "$ERROR_MSG" ]; then
                echo "   $ERROR_MSG"
              fi
            fi
          fi
          
          # Check for Cloudflare API errors
          if grep -qi "Cloudflare API error" bot.log 2>/dev/null; then
            echo ""
            echo "âš ï¸  Cloudflare API errors found:"
            grep -i "Cloudflare API error" bot.log | tail -3 | while read line; do
              echo "   $line"
            done
          fi
          
          # Check for successful API calls
          if grep -q "Cloudflare API success - received" bot.log 2>/dev/null; then
            SUCCESS_LINE=$(grep "Cloudflare API success - received" bot.log | tail -1)
            echo ""
            echo "âœ… $SUCCESS_LINE"
          fi
        else
          echo "â³ Bot log file not found yet, waiting for initialization..."
        fi
        
        echo "=========================================="
        echo ""
        echo "This workflow will stay 'Running' (yellow status) forever."
        echo "To stop the bot: Cancel this workflow in GitHub Actions UI"
        echo "To restart: Cancel workflow, then push a new commit or trigger manually"
        echo ""
        echo "=========================================="
        echo ""
        
        # Infinite loop - keeps workflow alive forever
        while true; do
          # Check if bot is still running
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo ""
            echo "=========================================="
            echo "âœ— Bot process died at $(date)"
            echo "=========================================="
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
          
          # Show timestamp and status
          echo "[$(date '+%Y-%m-%d %H:%M:%S UTC')] Check #$COUNTER - Bot alive (PID: $BOT_PID)"
          
          # Every 10 checks (50 minutes), show recent logs and Cloudflare status
          if [ $((COUNTER % 10)) -eq 0 ]; then
            echo ""
            echo "--- Recent bot activity (last 30 lines) ---"
            tail -30 bot.log | grep -v "^$" || echo "No recent activity"
            echo "--- End of recent activity ---"
            echo ""
            echo "--- Cloudflare Authentication Status ---"
            if grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
              echo "Recent Cloudflare API responses:"
              grep "Cloudflare API response: Status" bot.log | tail -3 | while read line; do
                echo "  $line"
              done || true
            fi
            if grep -qi "Cloudflare API error\|Cloudflare.*401\|Cloudflare.*403" bot.log 2>/dev/null; then
              echo "âš ï¸  Cloudflare errors:"
              grep -i "Cloudflare API error\|Cloudflare.*401\|Cloudflare.*403" bot.log | tail -3 | while read line; do
                echo "  $line"
              done || true
            fi
            if grep -q "Cloudflare API success" bot.log 2>/dev/null; then
              echo "âœ… Recent successful API calls:"
              grep "Cloudflare API success" bot.log | tail -2 | while read line; do
                echo "  $line"
              done || true
            fi
            echo "--- End Cloudflare Status ---"
            echo ""
          fi
          
          # Sleep for 5 minutes between checks
          sleep 300
          
          COUNTER=$((COUNTER + 1))
        done
