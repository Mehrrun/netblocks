name: Build and Deploy NetBlocks Bot

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: Download dependencies
      run: go mod download
      
    - name: Build Telegram Bot
      run: |
        echo "Building Telegram Bot..."
        go build -o netblocks-telegram-bot ./cmd/telegram-bot
        echo "Build complete!"
        ls -lh netblocks-telegram-bot
        
    - name: Verify secrets are set
      run: |
        echo "Verifying secrets..."
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          echo "ERROR: TELEGRAM_BOT_TOKEN secret is not set!"
          exit 1
        fi
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "ERROR: TELEGRAM_CHANNEL secret is not set!"
          exit 1
        fi
        echo "✓ Secrets are configured"
        
    - name: Verify Bot Binary
      run: |
        echo "Verifying bot binary..."
        if [ ! -f netblocks-telegram-bot ]; then
          echo "❌ Binary not found!"
          exit 1
        fi
        chmod +x netblocks-telegram-bot
        echo "✅ Binary is ready"
        file netblocks-telegram-bot
        
    - name: Setup systemd service
      run: |
        echo "Setting up systemd service for bot..."
        
        # Create systemd service file with environment variables
        sudo tee /etc/systemd/system/netblocks-bot.service > /dev/null <<EOF
        [Unit]
        Description=NetBlocks Telegram Bot - Iranian Network Monitoring
        After=network.target

        [Service]
        Type=simple
        WorkingDirectory=$(pwd)
        Environment="TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}"
        Environment="TELEGRAM_CHANNEL=${{ secrets.TELEGRAM_CHANNEL }}"
        ExecStart=$(pwd)/netblocks-telegram-bot
        Restart=always
        RestartSec=10
        StandardOutput=journal
        StandardError=journal
        SyslogIdentifier=netblocks-bot

        [Install]
        WantedBy=multi-user.target
        EOF
        
        # Reload systemd
        sudo systemctl daemon-reload
        echo "✓ Systemd service configured"
        
    - name: Start bot as systemd daemon
      run: |
        echo "Starting NetBlocks bot as systemd service..."
        
        # Start and enable the service
        sudo systemctl start netblocks-bot
        sudo systemctl enable netblocks-bot
        
        # Wait a moment for service to initialize
        sleep 3
        
        # Check service status
        sudo systemctl status netblocks-bot --no-pager
        
        echo ""
        echo "✓ Bot started as daemon"
        
    - name: Monitor bot daemon
      run: |
        echo "Bot is running as systemd daemon"
        echo "Monitoring logs..."
        echo ""
        
        # Show initial logs
        sudo journalctl -u netblocks-bot -n 50 --no-pager
        
        echo ""
        echo "Keeping workflow alive to maintain daemon..."
        echo "Status checks will run every 5 minutes"
        echo ""
        
        # Keep workflow running and periodically show logs
        while true; do
          sleep 300  # Wait 5 minutes
          echo ""
          echo "=== Bot Status Check ($(date)) ==="
          sudo systemctl is-active netblocks-bot || (
            echo "❌ Bot stopped! Showing recent logs:"
            sudo journalctl -u netblocks-bot -n 100 --no-pager
            exit 1
          )
          echo "✅ Bot is running"
          echo "Recent logs:"
          sudo journalctl -u netblocks-bot -n 20 --no-pager --since "5 minutes ago"
        done
        
    - name: Service debugging info (on failure)
      if: failure()
      run: |
        echo "Service failed! Debugging information:"
        echo ""
        echo "=== Service Status ==="
        sudo systemctl status netblocks-bot --no-pager --full
        echo ""
        echo "=== Recent Logs ==="
        sudo journalctl -u netblocks-bot -n 100 --no-pager
        echo ""
        echo "=== Service File ==="
        cat /etc/systemd/system/netblocks-bot.service
