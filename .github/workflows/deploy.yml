name: Run Bot 24/7

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/deploy.yml'
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 525600  # 1 year (maximum allowed)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      
    - name: Verify secrets
      run: |
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          echo "Error: TELEGRAM_BOT_TOKEN secret not set"
          exit 1
        fi
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "Warning: TELEGRAM_CHANNEL secret not set"
        fi
        if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
          echo "Warning: CLOUDFLARE_TOKEN not set - traffic charts will not be available"
        fi
        echo "‚úì Secrets verified"
      
    - name: Build bot
      run: |
        go build -o netblocks-telegram-bot ./cmd/telegram-bot
        chmod +x netblocks-telegram-bot
        echo "‚úì Bot built successfully"
      
    - name: Start bot in background
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        nohup ./netblocks-telegram-bot > bot.log 2>&1 &
        BOT_PID=$!
        echo $BOT_PID > bot.pid
        echo "‚úì Bot started with PID: $BOT_PID"
        echo "‚úì Environment variables set"
        
    - name: Wait for initialization
      run: sleep 10
      
    - name: Verify bot is running
      run: |
        if [ -f bot.pid ]; then
          BOT_PID=$(cat bot.pid)
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "‚úì Bot is running with PID: $BOT_PID"
            echo ""
            echo "============================================"
            echo "Full startup logs (showing Cloudflare auth):"
            echo "============================================"
            cat bot.log
            echo ""
            echo "============================================"
            echo "Bot started successfully!"
            echo "Channel: ${{ secrets.TELEGRAM_CHANNEL }}"
            echo "Entering monitoring mode..."
            echo "This workflow will run forever (never complete)"
            echo "============================================"
          else
            echo "‚úó Bot process not found"
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
        else
          echo "‚úó bot.pid file not found"
          exit 1
        fi
    
    - name: Monitor bot forever
      run: |
        BOT_PID=$(cat bot.pid)
        COUNTER=1
        
        echo ""
        echo "ü§ñ NetBlocks Bot is now running 24/7"
        echo "üìä Monitoring Iranian ASNs and DNS servers"
        echo "üì¢ Sending updates to Telegram channel every 10 minutes"
        echo ""
        
        # Print Cloudflare authentication and connection status
        echo "=========================================="
        echo "üîë Cloudflare Radar API Status:"
        echo "=========================================="
        
        # Check if bot log exists
        if [ ! -f bot.log ]; then
          echo "‚è≥ Bot log file not found yet, waiting for initialization..."
          echo "=========================================="
          echo ""
        else
          # Initialize status variables
          TOKEN_RECEIVED=false
          AUTH_METHOD=""
          API_CONNECTED=false
          DATA_AVAILABLE=false
          STATUS_CODE=""
          ERROR_MSG=""
          DATA_POINTS=0
          
          # Check if token was received
          if grep -q "NewTrafficMonitor: token set=true" bot.log 2>/dev/null; then
            TOKEN_RECEIVED=true
            TOKEN_LINE=$(grep "NewTrafficMonitor: token set=true" bot.log | tail -1)
            if echo "$TOKEN_LINE" | grep -q "len="; then
              TOKEN_LEN=$(echo "$TOKEN_LINE" | sed -n 's/.*len=\([0-9]*\).*/\1/p')
            fi
          fi
          
          # Check authentication method
          if grep -q "Using Cloudflare Bearer Token authentication" bot.log 2>/dev/null; then
            AUTH_METHOD="Bearer Token"
            if [ -n "$TOKEN_LEN" ]; then
              AUTH_METHOD="Bearer Token (length: $TOKEN_LEN)"
            fi
          fi
          
          # Check for Cloudflare API responses
          if grep -q "Cloudflare API response: Status 200" bot.log 2>/dev/null; then
            API_CONNECTED=true
            STATUS_CODE="200 OK"
            
            # Check if data was received
            if grep -q "Cloudflare API success - received" bot.log 2>/dev/null; then
              SUCCESS_LINE=$(grep "Cloudflare API success - received" bot.log | tail -1)
              DATA_AVAILABLE=true
              # Extract data points count
              if echo "$SUCCESS_LINE" | grep -q "received [0-9]* data points"; then
                DATA_POINTS=$(echo "$SUCCESS_LINE" | sed -n 's/.*received \([0-9]*\) data points.*/\1/p')
              fi
            fi
          elif grep -q "Cloudflare API response: Status 401" bot.log 2>/dev/null; then
            API_CONNECTED=false
            STATUS_CODE="401 Unauthorized"
            ERROR_MSG=$(grep -A 2 "Cloudflare API response: Status 401" bot.log | grep "Cloudflare API error" | tail -1 | sed 's/.*Cloudflare API error[^:]*: *//')
            if [ -z "$ERROR_MSG" ]; then
              ERROR_MSG="Token authentication failed - token may be invalid"
            fi
          elif grep -q "Cloudflare API response: Status 403" bot.log 2>/dev/null; then
            API_CONNECTED=false
            STATUS_CODE="403 Forbidden"
            ERROR_MSG=$(grep -A 2 "Cloudflare API response: Status 403" bot.log | grep "Cloudflare API error" | tail -1 | sed 's/.*Cloudflare API error[^:]*: *//')
            if [ -z "$ERROR_MSG" ]; then
              ERROR_MSG="Permission denied - token lacks Radar API permission"
            fi
          elif grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
            # Other status codes
            STATUS_LINE=$(grep "Cloudflare API response: Status" bot.log | tail -1)
            STATUS_CODE=$(echo "$STATUS_LINE" | sed -n 's/.*Status \([0-9]*\).*/\1/p')
            if [ "$STATUS_CODE" != "200" ]; then
              API_CONNECTED=false
              ERROR_MSG="HTTP Status $STATUS_CODE"
            fi
          elif grep -q "Error making HTTP request to Cloudflare" bot.log 2>/dev/null; then
            API_CONNECTED=false
            STATUS_CODE="Connection Failed"
            ERROR_MSG=$(grep "Error making HTTP request to Cloudflare" bot.log | tail -1 | sed 's/.*Error making HTTP request to Cloudflare: *//')
          fi
          
          # Print summary
          echo ""
          if [ "$TOKEN_RECEIVED" = true ]; then
            echo "‚úÖ Token Status: RECEIVED"
            if [ -n "$AUTH_METHOD" ]; then
              echo "   Authentication: $AUTH_METHOD"
            fi
          else
            echo "‚ùå Token Status: NOT RECEIVED"
            echo "   Check if CLOUDFLARE_TOKEN secret is set in repository settings"
          fi
          
          echo ""
          if [ "$API_CONNECTED" = true ]; then
            echo "‚úÖ Connection Status: CONNECTED to Cloudflare"
            echo "   HTTP Status: $STATUS_CODE"
            if [ "$DATA_AVAILABLE" = true ]; then
              if [ "$DATA_POINTS" -gt 0 ]; then
                echo "‚úÖ Data Status: AVAILABLE ($DATA_POINTS data points received)"
              else
                echo "‚úÖ Data Status: AVAILABLE (data received)"
              fi
              # Show traffic data details if available
              if grep -q "Traffic data processed successfully" bot.log 2>/dev/null; then
                TRAFFIC_LINE=$(grep "Traffic data processed successfully" bot.log | tail -1)
                echo "   $TRAFFIC_LINE"
              fi
            else
              echo "‚ö†Ô∏è  Data Status: API connected but no data received yet"
            fi
          else
            echo "‚ùå Connection Status: NOT CONNECTED to Cloudflare"
            if [ -n "$STATUS_CODE" ]; then
              echo "   HTTP Status: $STATUS_CODE"
            fi
            if [ -n "$ERROR_MSG" ]; then
              echo "   Error: $ERROR_MSG"
            fi
            echo "   Data Status: NOT AVAILABLE (using default 1% connection data)"
          fi
          
          echo ""
          echo "=========================================="
        fi
        
        echo "=========================================="
        echo ""
        echo "This workflow will stay 'Running' (yellow status) forever."
        echo "To stop the bot: Cancel this workflow in GitHub Actions UI"
        echo "To restart: Cancel workflow, then push a new commit or trigger manually"
        echo ""
        echo "=========================================="
        echo ""
        
        # Infinite loop - keeps workflow alive forever
        while true; do
          # Check if bot is still running
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo ""
            echo "=========================================="
            echo "‚úó Bot process died at $(date)"
            echo "=========================================="
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
          
          # Show timestamp and status
          echo "[$(date '+%Y-%m-%d %H:%M:%S UTC')] Check #$COUNTER - Bot alive (PID: $BOT_PID)"
          
          # Every 10 checks (50 minutes), show recent logs and Cloudflare status
          if [ $((COUNTER % 10)) -eq 0 ]; then
            echo ""
            echo "--- Recent bot activity (last 30 lines) ---"
            tail -30 bot.log | grep -v "^$" || echo "No recent activity"
            echo "--- End of recent activity ---"
            echo ""
            echo "--- Cloudflare Radar API Status ---"
            # Quick status check
            if grep -q "Cloudflare API response: Status 200" bot.log 2>/dev/null && grep -q "Cloudflare API success - received" bot.log 2>/dev/null; then
              echo "‚úÖ CONNECTED - Radar data is AVAILABLE"
              LATEST_SUCCESS=$(grep "Cloudflare API success - received" bot.log | tail -1)
              echo "  Latest: $LATEST_SUCCESS"
            elif grep -q "Cloudflare API response: Status 401\|Cloudflare API response: Status 403" bot.log 2>/dev/null; then
              echo "‚ùå NOT CONNECTED - Authentication failed"
              LATEST_ERROR=$(grep "Cloudflare API response: Status" bot.log | tail -1)
              echo "  $LATEST_ERROR"
            elif grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
              LATEST_STATUS=$(grep "Cloudflare API response: Status" bot.log | tail -1)
              echo "‚ö†Ô∏è  Status: $LATEST_STATUS"
            else
              echo "‚è≥ Waiting for Cloudflare API response..."
            fi
            echo "--- End Cloudflare Status ---"
            echo ""
          fi
          
          # Sleep for 5 minutes between checks
          sleep 300
          
          COUNTER=$((COUNTER + 1))
        done
