name: Run Bot 24/7

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/deploy.yml'
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 525600  # 1 year (maximum allowed)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      
    - name: Verify secrets
      run: |
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          echo "Error: TELEGRAM_BOT_TOKEN secret not set"
          exit 1
        fi
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "Warning: TELEGRAM_CHANNEL secret not set"
        fi
        echo "âœ“ Secrets verified"
      
    - name: Build bot
      run: |
        go build -o netblocks-telegram-bot ./cmd/telegram-bot
        chmod +x netblocks-telegram-bot
        echo "âœ“ Bot built successfully"
      
    - name: Start bot in background
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
      run: |
        nohup ./netblocks-telegram-bot > bot.log 2>&1 &
        BOT_PID=$!
        echo $BOT_PID > bot.pid
        echo "âœ“ Bot started with PID: $BOT_PID"
        echo "âœ“ Environment variables set"
        
    - name: Wait for initialization
      run: sleep 5
      
    - name: Verify bot is running
      run: |
        if [ -f bot.pid ]; then
          BOT_PID=$(cat bot.pid)
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "âœ“ Bot is running with PID: $BOT_PID"
            echo ""
            echo "Recent logs:"
            tail -20 bot.log
            echo ""
            echo "============================================"
            echo "Bot started successfully!"
            echo "Channel: ${{ secrets.TELEGRAM_CHANNEL }}"
            echo "Entering monitoring mode..."
            echo "This workflow will run forever (never complete)"
            echo "============================================"
          else
            echo "âœ— Bot process not found"
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
        else
          echo "âœ— bot.pid file not found"
          exit 1
        fi
    
    - name: Monitor bot forever
      run: |
        BOT_PID=$(cat bot.pid)
        COUNTER=1
        
        echo ""
        echo "ðŸ¤– NetBlocks Bot is now running 24/7"
        echo "ðŸ“Š Monitoring Iranian ASNs and DNS servers"
        echo "ðŸ“¢ Sending updates to Telegram channel every 10 minutes"
        echo ""
        echo "This workflow will stay 'Running' (yellow status) forever."
        echo "To stop the bot: Cancel this workflow in GitHub Actions UI"
        echo "To restart: Cancel workflow, then push a new commit or trigger manually"
        echo ""
        echo "=========================================="
        echo ""
        
        # Infinite loop - keeps workflow alive forever
        while true; do
          # Check if bot is still running
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo ""
            echo "=========================================="
            echo "âœ— Bot process died at $(date)"
            echo "=========================================="
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
          
          # Show timestamp and status
          echo "[$(date '+%Y-%m-%d %H:%M:%S UTC')] Check #$COUNTER - Bot alive (PID: $BOT_PID)"
          
          # Every 10 checks (50 minutes), show recent logs
          if [ $((COUNTER % 10)) -eq 0 ]; then
            echo ""
            echo "--- Recent bot activity (last 30 lines) ---"
            tail -30 bot.log | grep -v "^$" || echo "No recent activity"
            echo "--- End of recent activity ---"
            echo ""
          fi
          
          # Sleep for 5 minutes between checks
          sleep 300
          
          COUNTER=$((COUNTER + 1))
        done
