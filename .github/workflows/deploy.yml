name: Run Bot 24/7

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/deploy.yml'
      - 'cmd/**'
      - 'internal/**'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 525600  # 1 year (maximum allowed)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
      
    - name: Verify secrets
      run: |
        if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
          echo "Error: TELEGRAM_BOT_TOKEN secret not set"
          exit 1
        fi
        if [ -z "${{ secrets.TELEGRAM_CHANNEL }}" ]; then
          echo "Warning: TELEGRAM_CHANNEL secret not set"
        fi
        if [ -z "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
          echo "Warning: CLOUDFLARE_TOKEN not set - traffic charts will not be available"
        fi
        echo "‚úì Secrets verified"
      
    - name: Build bot
      run: |
        go build -o netblocks-telegram-bot ./cmd/telegram-bot
        chmod +x netblocks-telegram-bot
        echo "‚úì Bot built successfully"
      
    - name: Start bot in background
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      run: |
        nohup ./netblocks-telegram-bot > bot.log 2>&1 &
        BOT_PID=$!
        echo $BOT_PID > bot.pid
        echo "‚úì Bot started with PID: $BOT_PID"
        echo "‚úì Environment variables set"
        
    - name: Wait for initialization
      run: sleep 10
      
    - name: Verify bot is running
      run: |
        if [ -f bot.pid ]; then
          BOT_PID=$(cat bot.pid)
          if kill -0 $BOT_PID 2>/dev/null; then
            echo "‚úì Bot is running with PID: $BOT_PID"
            echo ""
            echo "============================================"
            echo "Full startup logs (showing Cloudflare auth):"
            echo "============================================"
            cat bot.log
            echo ""
            echo "============================================"
            echo "Bot started successfully!"
            echo "Channel: ${{ secrets.TELEGRAM_CHANNEL }}"
            echo "Entering monitoring mode..."
            echo "This workflow will run forever (never complete)"
            echo "============================================"
          else
            echo "‚úó Bot process not found"
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
        else
          echo "‚úó bot.pid file not found"
          exit 1
        fi
    
    - name: Monitor bot forever
      run: |
        BOT_PID=$(cat bot.pid)
        COUNTER=1
        
        echo ""
        echo "ü§ñ NetBlocks Bot is now running 24/7"
        echo "üìä Monitoring Iranian ASNs and DNS servers"
        echo "üì¢ Sending updates to Telegram channel every 10 minutes"
        echo ""
        
        # Print Cloudflare authentication status
        echo "=========================================="
        echo "üîë Cloudflare Authentication Status:"
        echo "=========================================="
        if [ -n "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then
          TOKEN_LEN=${#CLOUDFLARE_TOKEN}
          echo "‚úÖ CLOUDFLARE_TOKEN is set (length: $TOKEN_LEN characters)"
          if [ $TOKEN_LEN -gt 0 ]; then
            echo "‚úÖ Token is non-empty"
          else
            echo "‚ùå Token is empty!"
          fi
        else
          echo "‚ùå CLOUDFLARE_TOKEN secret is not set"
        fi
        
        # Check if token is passed to bot process
        if grep -q "NewTrafficMonitor: token set=true" bot.log 2>/dev/null; then
          echo "‚úÖ Bot process received Cloudflare token"
          grep "NewTrafficMonitor: token" bot.log | tail -1 || true
        elif grep -q "NewTrafficMonitor: token set=false" bot.log 2>/dev/null; then
          echo "‚ùå Bot process did NOT receive Cloudflare token"
        else
          echo "‚è≥ Waiting for bot to initialize and check token..."
        fi
        
        # Check for Cloudflare API authentication logs
        if grep -q "Using Cloudflare Bearer Token authentication" bot.log 2>/dev/null; then
          echo "‚úÖ Bot is using Cloudflare Bearer Token authentication"
          grep "Using Cloudflare.*authentication" bot.log | tail -1 || true
        fi
        
        # Check for Cloudflare API response
        if grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
          echo ""
          echo "üì° Recent Cloudflare API responses:"
          grep "Cloudflare API response: Status" bot.log | tail -3 || true
        fi
        
        # Check for Cloudflare errors
        if grep -qi "Cloudflare.*error\|Cloudflare.*401\|Cloudflare.*403\|WARNING: No Cloudflare credentials" bot.log 2>/dev/null; then
          echo ""
          echo "‚ö†Ô∏è  Cloudflare warnings/errors found:"
          grep -i "Cloudflare.*error\|Cloudflare.*401\|Cloudflare.*403\|WARNING: No Cloudflare credentials" bot.log | tail -3 || true
        fi
        
        echo "=========================================="
        echo ""
        echo "This workflow will stay 'Running' (yellow status) forever."
        echo "To stop the bot: Cancel this workflow in GitHub Actions UI"
        echo "To restart: Cancel workflow, then push a new commit or trigger manually"
        echo ""
        echo "=========================================="
        echo ""
        
        # Infinite loop - keeps workflow alive forever
        while true; do
          # Check if bot is still running
          if ! kill -0 $BOT_PID 2>/dev/null; then
            echo ""
            echo "=========================================="
            echo "‚úó Bot process died at $(date)"
            echo "=========================================="
            echo ""
            echo "Full logs:"
            cat bot.log
            exit 1
          fi
          
          # Show timestamp and status
          echo "[$(date '+%Y-%m-%d %H:%M:%S UTC')] Check #$COUNTER - Bot alive (PID: $BOT_PID)"
          
          # Every 10 checks (50 minutes), show recent logs and Cloudflare status
          if [ $((COUNTER % 10)) -eq 0 ]; then
            echo ""
            echo "--- Recent bot activity (last 30 lines) ---"
            tail -30 bot.log | grep -v "^$" || echo "No recent activity"
            echo "--- End of recent activity ---"
            echo ""
            echo "--- Cloudflare Status Check ---"
            if grep -q "Cloudflare API response: Status" bot.log 2>/dev/null; then
              echo "Recent Cloudflare API responses:"
              grep "Cloudflare API response: Status" bot.log | tail -3 || true
            fi
            if grep -qi "Cloudflare.*error\|Cloudflare.*401\|Cloudflare.*403" bot.log 2>/dev/null; then
              echo "‚ö†Ô∏è  Cloudflare errors:"
              grep -i "Cloudflare.*error\|Cloudflare.*401\|Cloudflare.*403" bot.log | tail -3 || true
            fi
            echo "--- End Cloudflare Status ---"
            echo ""
          fi
          
          # Sleep for 5 minutes between checks
          sleep 300
          
          COUNTER=$((COUNTER + 1))
        done
